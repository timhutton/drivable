<!DOCTYPE HTML>
<html>
<head>
<style>
    body {
        margin: 10px;
        padding: 0px;
    }
</style>
</head>
<body>
<canvas id="myCanvas" width="700" height="700"></canvas>
<script>
function draw(canvas) {
    var context = canvas.getContext('2d');

    context.beginPath();
    context.rect(0, 0, canvas.width, canvas.height);
    context.fillStyle = 'white';
    context.fill();
    context.lineWidth = 1;
    context.strokeStyle = 'black';
    context.stroke();
    
    // draw each truck as a rectangle
    var h = 40;
    var y = 200;
    for( var i = 0; i < N_VARIABLES; i++ ) {
        var v = variables[i];
        context.beginPath();
        context.rect( v-truck_width/2, y, truck_width, h);
        if( i == iDriver ) {
            if( currentMousePositionAccepted )
                context.fillStyle = 'black';
            else
                context.fillStyle = 'red';
        }
        else
            context.fillStyle = 'grey';
        context.fill();
        context.lineWidth = 1;
        context.strokeStyle = 'black';
        context.stroke();
    }
    
    // plot
    for( var iPlotConnection = 0; iPlotConnection < N_CONNECTIONS; iPlotConnection++ ) {
        var connection = connections[iPlotConnection];
        var x = variables[connection.a];
        var y = variables[connection.b];
        context.beginPath();
        context.arc(x, y, 3, 0, 2*Math.PI);
        context.fillStyle = 'blue';
        context.fill();
        for( var iSegment = 0; iSegment < connection.segments.length; iSegment++) {
            var segment = connection.segments[iSegment];
            context.beginPath();
            context.moveTo(segment.p1.x, segment.p1.y);
            context.lineTo(segment.p2.x, segment.p2.y);
            context.lineWidth = 1;
            context.strokeStyle = 'black';
            context.stroke();
        }
    }
}

function tryMoveDriver(mousePos) {
    // the mouse drives the variable indexed by iDriver
    var old_value = variables[iDriver];
    var new_value = mousePos.x; 
    // for each connection that involves this variable, construct the line segment in the state
    // space of the two variables that this move represents, and see if it intersects any constraints
    for( var iConnection = 0; iConnection < N_CONNECTIONS; iConnection++ ) {
        var connection = connections[iConnection];
        var other_value = 0;
        if( connection.a == iDriver )
            other_value = variables[ connection.b ];
        else if( connection.b == iDriver )
            other_value = variables[ connection.a ];
        else
            continue;
        var moveSegment = new LineSegment( new Point( old_value, other_value ), new Point( new_value, other_value ) );
        for( var iSegment = 0; iSegment < connection.segments.length; iSegment++ ) {
            var constraint_segment = connection.segments[iSegment];
            var ip = lineSegmentsIntersection( constraint_segment, moveSegment );
            if( ip.test == true ) {
                // for now, just disallow this move
                return false;
           }
        }
    }
    
    variables[iDriver] = new_value;
    return true;
}

function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}
var canvas = document.getElementById('myCanvas');
var context = canvas.getContext('2d');

// A drivable constraint is a line segment in the 2D space of two variables
// representing a contact between two pieces. (Could generalize to curve segments.)
// If your intended step takes you across the segment then it steers you to
// one side or the other. if you meet it at right-angles then you get stuck
// and can go no further. (For parts with more than one way of moving (e.g. sliding cogs)
// a drivable constraint would be a patch of surface but we ignore such cases for now.)

// A tricky question is how to compute these segments for a set of moving parts.
// But if we know the segments then we can use them and let the user move the parts around.
// So for now we manually specify a list of segments.

// Each part has (for now) one variable that controls how it can move. e.g. a truck has a single
// position, a rotating arm has an angle.
// If two parts are capable of directly interacting then they have a connection. A connection is a list
// of drivable constraints.

function Point(x,y) {
    this.x = x;
    this.y = y;
}
function LineSegment(p1,p2) {
    this.p1 = p1;
    this.p2 = p2;
}

function lineSegmentsIntersection(s1,s2) {
    return lineSegmentsIntersection2(s1.p1.x,s1.p1.y,s1.p2.x,s1.p2.y,s2.p1.x,s2.p1.y,s2.p2.x,s2.p2.y);
}
function lineSegmentsIntersection2(a,b,c,d,p,q,r,s) {
  var det, gamma, lambda;
  det = (c - a) * (s - q) - (r - p) * (d - b);
  if (det === 0) {
    return { test:false, point:null };
  } else {
    lambda = ((s - q) * (r - a) + (p - r) * (s - b)) / det;
    gamma = ((b - d) * (r - a) + (c - a) * (s - b)) / det;
    var intersects = (0 <= lambda && lambda <= 1) && (0 <= gamma && gamma <= 1);
    var p = new Point( a + lambda * c, b + lambda*d );
    return { test: intersects, point:p };
  }
};

var N_VARIABLES = 2;
var variables = new Array(N_VARIABLES);
variables[0] = 500;
variables[1] = 200;

function Connection(a,b) {
    this.a = a; // this indexed variable is the x-coordinate
    this.b = b; // this indexed variable is the y-coordinate
    this.segments = [];
}

var truck_width = 60;

var N_CONNECTIONS = 1;
var connections = new Array(N_CONNECTIONS);
connections[0] = new Connection(0,1); 
connections[0].segments.push(new LineSegment(new Point(0,truck_width),new Point(canvas.width-truck_width,canvas.width)));
connections[0].segments.push(new LineSegment(new Point(truck_width,0),new Point(canvas.width,canvas.width-truck_width)));
    
// one truck is the driver to start with
var iDriver = 1;
var currentMousePositionAccepted = true;
draw(canvas);

canvas.addEventListener('mousemove', function(evt) {
    var mousePos = getMousePos(canvas, evt);
    currentMousePositionAccepted = tryMoveDriver( mousePos );
    draw(canvas);
}, false);

canvas.addEventListener('click', function(evt) {
    iDriver = 1-iDriver;
    draw(canvas);
}, false);

</script>
</body>
</html>
